name: Deploy Vettex to Cloud Run

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # This step creates the Dockerfile directly in the workflow
      - name: Create Dockerfile dynamically
        run: |
          cat <<EOF > Dockerfile
          FROM python:3.11-slim
          WORKDIR /app
          COPY requirements.txt .
          RUN pip install --no-cache-dir -r requirements.txt
          COPY . .
          # We use a backslash before the dollar sign so GitHub doesn't try to interpret it
          CMD ["sh", "-c", "uvicorn main:app --host 0.0.0.0 --port \${PORT:-8080}"]
          EOF

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: vettex-service
          region: us-central1
          source: .  # This now sees the 'Dockerfile' created in the previous step
          env_vars: |
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
