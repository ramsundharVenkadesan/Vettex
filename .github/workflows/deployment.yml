name: Deploy Vettex to Cloud Run

on:
  push:
    branches: [ main ]  # Triggers deployment when you push to the main branch

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: 'read'
      id-token: 'write' # Required for Workload Identity Federation

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.WIF_SERVICE_ACCOUNT }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: vettex-service
          region: us-central1
          source: . # Automatically builds your Dockerfile
          env_vars: |
            GOOGLE_API_KEY=${{ secrets.GOOGLE_API_KEY }}
            TAVILY_API_KEY=${{ secrets.TAVILY_API_KEY }}
